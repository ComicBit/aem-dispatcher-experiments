# Effect of the `gracePeriod` setting

This experiment demonstrates the impact that the `gracePeriod` setting can have when a system under load receives a number of cache invalidation events in quick succession.

## Compatibility

This experiment is compatible with both AEM 6.5 and AEM as a Cloud Service.

## Setup

The role of the gracePeriod setting is well stated in the dispatcher.any comments:

> A grace period defines the number of seconds a stale, auto-invalidated resource may still be served from the cache after the last activation occurring. Auto-invalidated resources are invalidated by any activation, when their path matches the /invalidate section above. This setting can be used in a setup, where a batch of activations would otherwise repeatedly invalidate the entire cache.

Open your dispatcher.any config file, and locate the `/gracePeriod` configuration. If you are using the [dispatcher.any from this repository](../../dispatcher-config-basic/private/etc/apache2/conf/dispatcher.any), it will look like so (around line 122):

    #/gracePeriod "2"

It's commented out by default _unless_ you have a codebase that was generated from the [AEM Project Archetype](https://github.com/adobe/aem-project-archetype) with the `aemVersion=cloud` flag set. You can leave it commented out for now.

## Problem

Let's say you have a large site which includes some assets that are generated by AEM. Once the assets are generated, they are all activated one after another to the publish instance. Each activation causes an auto-invalidation to occur which - depending on the configuration of `/invalidate` and `/statfileslevel` - could invalidate all .html files in the cache. This means that the next request for each .html file will make it's way back to the publish instance.

In a high traffic scenario, this can mean there are lots of page renders for the publish instance to process (in addition to handling the incoming activation events). To complicate matters, as soon as the publish instance has finished rendering a page, it is considered "stale" again as soon as the next activation action is received! This cycle can continue until the publish instance ends up overwhelmed.

Let's simulate this scenario using a JMeter script that can both issue end-user GET requests as well as invalidation events to our dispatcher. The latter can be performed by making the following request to the dispatcher (see [Manually Invalidating the Dispatcher Cache](https://docs.adobe.com/content/help/en/experience-manager-dispatcher/using/configuring/page-invalidate.html#manually-invalidating-the-dispatcher-cache) for details):

```
POST http://aem-publish.local:8080/dispatcher/invalidate.cache HTTP/1.1  
CQ-Action: Activate  
CQ-Handle: /content/dispatchertester/us/en/regular-page
Content-Length: 0
```

You can try the above with cURL or Postman yourself.

## Test #1: no gracePeriod